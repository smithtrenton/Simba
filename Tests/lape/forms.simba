program new;

const
  PAGE_DIALOGS = 0;
  PAGE_IMAGES = 1;
  PAGE_OTHER = 2;

var
  frm: TForm;
  mainMenu: TMainMenu;
  menuHelp, subMenuHelp: TMenuItem;
  btnColorPicker, btnOpenDialog, btnAddString: TButton;
  tabControl: TPageControl;
  tabs: array [0..2] of TTabSheet;
  colorDialog: TColorDialog;
  openDialog: TOpenDialog;
  img, imgText: TImage;
  btnSpin: TSpinEdit;
  statusBar: TStatusBar;
  statusPanelTxt: TStatusPanel;
  speedButton: TSpeedButton;
  checkList: TCheckListBox;

procedure OnClickCheckList(sender: TObject; index: Integer); {$IFNDEF CODEINSIGHT} native; {$ENDIF}
begin
  Client.Writeln(toString(index));
end;

procedure OnKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);  {$IFNDEF CODEINSIGHT} native; {$ENDIF}
begin
  Client.WriteLn('KeyUp - ' + toString(Key));
end;

procedure OnKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState); {$IFNDEF CODEINSIGHT} native; {$ENDIF}
begin
  Client.WriteLn('KeyDown - ' + toString(Key));
end;

procedure OnKeyPress(Sender: TObject; var Key: char); {$IFNDEF CODEINSIGHT} native; {$ENDIF}
begin
  Client.WriteLn('KeyPress - ' + toString(Key));
end;

procedure onClick(sender: TObject); {$IFNDEF CODEINSIGHT} native; {$ENDIF}
var
  i: integer;
begin

  case sender of
    btnColorPicker:
      with colorDialog do
      begin
        init(frm);
        execute();

        client.writeln('Color picked: ' +toStr(getColor()));
        client.writeln('Custom Colors:');

        for i := 0 to (getCustomColors().getCount() - 1) do
          client.writeln(getCustomColors().getStrings(i));

        free();
      end;

    btnOpenDialog:
      with openDialog do
      begin
        init(frm);
        execute();
        client.writeln('File path picked: '+getFileName());
        free();
      end;

    btnAddString:
      begin
        checkList.getItems().add(format('This string(%d) was added', [checkList.getItems().getCount() + 1]));
      end;
  end;
end;

procedure Help_OnClick(sender: TObject);  {$IFNDEF CODEINSIGHT} native; {$ENDIF}
begin
  client.writeln('Click!');
end;

procedure init(); {$IFNDEF CODEINSIGHT} native; {$ENDIF}
var
  i: integer;
  tabCaptions: TStringArray = ['Dialogs', 'Images', 'Other'];
  panelCaptions: TStringArray = ['Hello', 'Bart', 'How Are You', 'Today'];
  tpa: TPointArray;
  bmp: TBitmap;
begin
  frm.init(nil);

  with frm do
  begin
    setWidth(500);
    setHeight(300);
    setPosition(poScreenCenter);
    setCaption('Lape Form - Test');
    setBorderIcons([biSystemMenu, biMinimize]);
  end;


  statusBar.init(frm);

  with (statusBar) do
  begin
    setParent(frm);
    setSimplePanel(false);

    with getPanels() do
    begin
      for i := 0 to 3 do
      begin
        add();
        getItems(i).setWidth(length(panelCaptions[i]) * 8);
        getItems(i).setText(panelCaptions[i]);
      end;
    end;
  end;

  mainMenu.init(frm);

  menuHelp := mainMenu.addMenu('Help');
  subMenuHelp := menuHelp.addMenu('What with');
  subMenuHelp.setOnClick(Help_OnClick);

  bmp.init();
  //bmp.loadFromFile('C:\Simba\cross.bmp');
  //client.writeln(bmp.toString());

  bmp.loadFromString(16, 16, 16777215, 'FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDF9F5F5E4D6EACAB0E1BB9DDAB393D9B395E6CFBCF7F1ECFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFBF1E9F1D3BBF4E3D4F3E5D9F2E5DAF2E4D9EFE1D3E4CCB9C99D79EAD9CBFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFCF2EAF3D4BBF6E9DDEFDCCDDFBB9ED1A67ED1A57AD9B595EAD6C5EAD8C9BE8C62E7D5C6FFFFFFFFFFFFFFFFFFFEFAF7F6DAC3F7EADFECD8C6D5A87ECFA075CC9D71C5996BC7986CC79971E3CDBAE7D5C4BA895FF4ECE5FFFFFFFFFFFFFCEDE1F9E9DCEEDED0D7AC81D0A077CD9E72C79A6CC4976AC39569BF9066C0946BE5D2BFD7BBA3D6BAA2FFFFFFFFFFFFF8DEC9F6E8DDE3C1A7DCBB9AFBF8F5F5EBE3C5986BC49669C19367BF9066BA8C62C9A685E9DACAB6845AFFFFFFFFFFFFF6D9C1F3E5DAD8AE89F6ECE3FCF8F5E4CBB4E2CCB6FAF6F2BF9066F7F1ECCFB094B88E67ECE0D1AC7445FFFFFFFFFFFFF5D7BFF3E5DAD7AC86F5ECE2FCF8F5E7D3BFF8F3EEF3EAE1BF9066F6F0EACFB094B68A65ECE0D1AB7243FFFFFFFFFFFFF5D9C3F5E7DCDDBB9CE4C8AEFBF8F5FBF8F6F6EEE8C2956DBB8B63B7895FB7895FC5A180E8D8C8B27E53FFFFFFFFFFFFF8E8DCF5E4D6EBD6C7D2A77BD1A881E5D3BFD9BDA1BE8F65B98A63B7895FB28761E0CCBAD3B59CD2B59CFFFFFFFFFFFFFDF8F5EDCDB4F3E6D9E6CEBACFA47BC4986BC29468BE8F64B88A62B58963DAC0AAE3D0BEB07A4DF2EAE3FFFFFFFFFFFFFFFFFFF8ECE3E4C1A3F1E2D5EAD5C3D6B491C59B71C0956DCBA786E2CEBBE4D1C0AF7648E2CFBEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5E9DFDFBB9CEAD4C2EEE0D2F0E2D6EFE3D5EADCCCD9BDA6B68359E3D0C0FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFAF4F0E9D4C2D3AC8BC79971C19067C2956FD9BEA7F4ECE6FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF');
  subMenuHelp.setBitmap(bmp);

  bmp.free();

  tabControl.init(frm);

  with tabControl do
  begin
    setParent(frm);
    setBounds(0, 0, 400, 254);

    for i := 0 to high(tabs) do
    begin
      tabs[i] := addTabSheet();
      tabs[i].setCaption(tabCaptions[i]);
    end;

    setOnKeyPress(OnKeyPress);
    setOnKeyDown(OnKeyDown);
    setOnKeyUp(OnKeyUp);
  end;

  btnColorPicker.init(frm);

  with btnColorPicker do
  begin
    setParent(tabs[PAGE_DIALOGS]);
    setLeft(10);
    setTop(10);
    setCaption('Color picker');
    setOnClick(onClick);
    setHint('This will open a color picker');
    setShowHint(true);
  end;

  btnOpenDialog.init(frm);

  with btnOpenDialog do
  begin
    setParent(tabs[PAGE_DIALOGS]);
    setLeft(10);
    setTop(40);
    setCaption('File dialog');
    setOnClick(onClick);
  end;

  img.init(frm);

  with img do
  begin
    setParent(tabs[PAGE_IMAGES]);
    setBounds(20, 20, 50, 50);
    getCanvas().rectangle(0, 0, 50, 50);
    getCanvas().setPixel(20, 20, 255);

    setLength(tpa, 2000);

    for i := 0 to high(tpa) do
      tpa[i] := point(randomRange(1, 49), randomRange(1, 49));

    getCanvas().setPixels(tpa, 255);

    setHint('Hello');
    setShowHint(true);
  end;

  imgText.init(frm);

  with imgText do
  begin
    setParent(tabs[PAGE_IMAGES]);
    setBounds(100, 100, 200, 120);
    getCanvas().rectangle(0, 0, 200, 120);
    getCanvas().getFont().setSize(60);
    getCanvas().getFont().setQuality(fqCleartypeNatural);
    getCanvas().textOut(5, 1, 'Hello');
  end;

  btnSpin.init(frm);

  with btnSpin do
  begin
    setParent(tabs[PAGE_OTHER]);
    setBounds(10, 10, 50, 50);
    setValue(25);
    setMinValue(-50);
  end;

  bmp.init();
  bmp.loadFromString(26, 27, 0, '000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040B250E216F040A23000000000000000000000000000000000000000000000000000000000000030622080E560304200000000000000000000000000000000000000000000000000000000000000B1B56284AC17796E31C3AB607113B000000000000000000000000000000000000000000000000060A381A248D717BCB191F860507330000000000000000000000000000000000000000000000000B1B58294CC499B9F69CBDF96E95EC1A38B207103A000000000000000000000000000000000000060B391B2691828DD68A94DA5C67CA181E830406310000000000000000000000000000000000000B1C592B4FC799BAF695B7F35A8AE3588AEA668DEB1A35AE060F38000000000000000000000000060D3B1B2995828FD88590D64150B83948B8505AC4181C8104053000000000000000000000000007143E2B51C99ABCF795B9F55B8DE64F82E04E80E05785E66489E91932A9060E37000000000000070E3D1C2C998492DB8693D84253BA3141B1303FAF3845B7515CC5171A7F010214000000000000000000122E8E8CAFEE9BC0FC5D92E95186E44F82E04C7EDE4D7BDC5480E26284E51830A5060D35070F401E2F9D8595DE8796DA4458BD3345B43141B12F3EAE313EB04552C4444CB506074300000000000000000007143E284DC875A6F55C94F05287E54F82E04C7EDE4B79DA4A76D8527BDE6180E2172DA11F32A18899E18899DC465CC1354AB73345B43141B13140B03A47B9444FBF0E11790102140000000000000000000000000A1B54264BC66EA0F55B90EE5083E14C7EDE4B79DA4874D64871D44F75DA5773D68296DF8A9DDF4760C3374FBB354AB73345B43343B33B4ABA444FBF0F137B0304270000000000000000000000000000000000000A1A532649C36D9CF4598CEA4D7FDF4B79DA4874D6466FD2456BD04568CE5571D04A65C73954BE374FBB354AB73547B63D4DBD4551C00F157E0405280000000000000000000000000000000000000000000000000A18502548C06B99F35688E84C7ADB4874D6466FD24369CE4164CA3E5EC73C59C23954BE374FBB374CB93F51C04654C310168104062900000000000000000000000000000000000000000000000000000000000009184E2545BD6A95F25583E44975D7466FD24369CE4164CA3E5EC73C59C23954BE3951BD4156C34858C610198404062A00000000000000000000000000000000000000000000000000000000000000000000000009174D2443BA5F88E94B77D9466FD24369CE4164CA3E5EC73C59C23954BE3C54C04154C1111B8704072C00000000000000000000000000000000000000000000000000000000000000000000000000000009174D2544BA86A3EB5780DC466FD24369CE4164CA3E5EC73C59C23954BE3C54C04255C2121C8804072D00000000000000000000000000000000000000000000000000000000000000000000000009184E2646BD91AFF292B0EE557EDA466FD24369CE4164CA3E5EC73C59C23954BE3850BC4156C35464CA141D8604062C0000000000000000000000000000000000000000000000000000000000000A18502649C093B2F393B3F05883DD4874D6466FD24369CE4164CA3E5EC73C59C23954BE374FBB364BB83F51C05360C7141A8204062B0000000000000000000000000000000000000000000000000A1951274AC393B4F495B5F25988E14B79DA4874D6466FD2446ACF4568CE4262CB3D5AC33954BE374FBB354AB73446B53D4DBD525DC413197F04052A0000000000000000000000000000000000000A1A52274CC694B6F496B8F45C8BE34C7EDE4B79DA4874D64770D34F75DA4B6BD54C6AD54663CC3A55BF374FBB354AB73345B43242B23B4ABA515BC313177D03042900000000000000000000000007143E284DC894B8F597BBF55E8FE74F82E04C7EDE4B79DA4975D7527BDE5679E2152CA11C30A25C76DA435EC83850BC354AB73345B43141B1303FAF3A47B9515BC212157B02031D000000000000000000122E8E8CAFEE9DC1FC5F94EA5186E44F82E04C7EDE4C7ADB5480E2597EE6162FA5060E37070F401F309E5A71D64159C5364BB83345B43141B12F3EAE303DAF424FC14F58BF07084D00000000000000000007143E2B51C977A9F85B93EF5287E54F82E04D7FDF5785E65B83EA1831A9060F39000000000000070E3F1E2E9B586CD33F54C13446B53141B1303FAF3643B54955C6191E8702031D0000000000000000000000000B1D5B2A4FC76EA1F75A8FED5184E2588AEA5D87EC1A36AF070F3A000000000000000000000000060D3D1D2B965669CF3D4FBE3343B33746B64753C41A1F880506390000000000000000000000000000000000000B1C5A2A4DC56F9FF76497F55E8BED1A39B307103C000000000000000000000000000000000000060C3B1C28925464CD4353C34957C61A218B05073A0000000000000000000000000000000000000000000000000B1B58294CC2608AE51B3BB707123D000000000000000000000000000000000000000000000000060B391B268E5562CC1B228D05083C000000000000000000000000000000000000000000000000000000000000050D2B0E2375050C2A00000000000000000000000000000000000000000000000000000000000004072B09105F040629000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000');

  speedButton.init(frm);

  with (speedButton) do
  begin
    setParent(tabs[PAGE_OTHER]);
    setBounds(9, 40, 100, 40);
    setGlyph(bmp);
    setCaption('Close');
  end;

  bmp.free();

  checkList.Init(frm);
  with (checkList) do
  begin
    setParent(tabs[PAGE_OTHER]);
    setBounds(9, 90, 200, 100);
    setOnItemClick(OnClickCheckList);
  end;

  btnAddString.Init(frm);
  with (btnAddString) do
  begin
    setParent(tabs[PAGE_OTHER]);
    setBounds(218, 100, 100, 25);
    setCaption('Add a string');
    setOnClick(onClick);
  end;



  client.writeln('Showing form...');
  frm.showModal();
end;

procedure free(); {$IFNDEF CODEINSIGHT} native; {$ENDIF}
begin
  if (frm = nil) then
    exit();

  client.writeln('Freeing form...');
  frm.free();
end;

procedure showForm();
begin
  try
    sync(init);
  except
    writeln('ERROR: Failed to initialize form');
  finally
    sync(free);
  end;
end;

begin
  clearDebug();
  showForm();
end.
